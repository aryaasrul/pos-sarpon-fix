import{j as e,s as h}from"../assets/index-Xju1durr.js";import{r as l}from"./chunk-Dqgx_XrJ.js";import{V as $}from"./chunk-nGiK0_2R.js";import"./chunk-CqGYk7DY.js";import"./chunk-DsIAwHzQ.js";function N(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){const g=Math.random()*16|0;return(i==="x"?g:g&3|8).toString(16)})}function R({cart:i,onOrderSuccess:g}){const[m,w]=l.useState(!1),D=i.reduce((o,a)=>o+a.price*a.quantity,0),O=async()=>{if(i.length===0){$.error("Keranjang masih kosong!");return}w(!0);const o=$.loading("Memproses transaksi...");try{const{data:{user:a},error:c}=await h.auth.getUser();if(c)throw new Error("Sesi tidak valid: "+c.message);if(!a)throw new Error("Silakan login untuk melakukan transaksi.");const E=N(),y=i.filter(s=>s.type==="BOOK");if(y.length>0)for(const s of y){if(!s.book_id)throw new Error(`Book ID missing for item: ${s.name}`);const{data:t,error:n}=await h.from("books").select("stock_quantity, title, id").eq("id",s.book_id).single();if(n)throw new Error(`Gagal validasi buku: ${n.message}`);if(!t)throw new Error(`Buku dengan ID ${s.book_id} tidak ditemukan`);if(t.stock_quantity<s.quantity)throw new Error(`Stok buku "${t.title}" tidak mencukupi. Tersisa: ${t.stock_quantity}, diminta: ${s.quantity}`)}const b=i.map(s=>{const t={transaction_id:E,name:s.name,quantity:s.quantity,price:s.price,hpp:s.hpp||0,user_id:a.id,product_type:s.type,created_at:new Date().toISOString()};return s.type==="BOOK"&&s.book_id&&(t.book_id=s.book_id),t}),{data:B,error:_}=await h.from("orders").insert(b).select();if(_)throw _.message.includes("uuid")||_.code==="22P02"?new Error("Format data tidak valid. Silakan refresh halaman dan coba lagi."):_.message.includes("foreign key")?new Error("Referensi data tidak valid. Silakan refresh halaman."):new Error(`Gagal menyimpan transaksi: ${_.message}`);if(y.length>0)for(const s of y)try{const{data:t,error:n}=await h.rpc("decrement_book_stock",{book_id:s.book_id,quantity_to_subtract:s.quantity});if(n&&n.message.includes("function")){const{data:r,error:T}=await h.from("books").select("stock_quantity, title").eq("id",s.book_id).single();if(T)throw new Error(`Gagal mengambil data buku: ${T.message}`);const k=r.stock_quantity-s.quantity;if(k<0)throw new Error(`Stok buku "${r.title}" tidak mencukupi untuk transaksi ini`);const{data:M,error:u}=await h.from("books").update({stock_quantity:k,updated_at:new Date().toISOString()}).eq("id",s.book_id).select("stock_quantity, title");if(u)throw new Error(`Gagal update stok: ${u.message}`)}else if(n)throw new Error(`Gagal update stok buku: ${n.message}`);const{error:d}=await h.from("book_stock_movements").insert([{book_id:s.book_id,movement_type:"OUT",quantity:s.quantity,reference_type:"SALE",reference_id:E,notes:`Penjualan - ${s.name}`,user_id:a.id,created_at:new Date().toISOString()}])}catch{}$.dismiss(o);const S=i.filter(s=>s.type==="MENU").length,f=i.filter(s=>s.type==="BOOK").length;let x=`ðŸŽ‰ Transaksi berhasil!
ðŸ’° Total: Rp ${D.toLocaleString("id-ID")}`;S>0&&f>0?x+=`
â˜• ${S} menu, ðŸ“š ${f} buku`:S>0?x+=`
â˜• ${S} item menu`:f>0&&(x+=`
ðŸ“š ${f} buku`),x+=`
ðŸ†” ID: ${E.slice(0,8)}...`,$.success(x,{duration:5e3}),g()}catch(a){$.dismiss(o);let c="Gagal memproses pesanan";a.message.includes("Stok buku")?c=`ðŸ“š ${a.message}`:a.message.includes("Book ID missing")?c="ðŸ“š Data buku tidak valid. Silakan refresh halaman dan coba lagi.":a.message.includes("uuid")||a.message.includes("Format data")?c="ðŸ”§ "+a.message:a.message.includes("network")||a.message.includes("fetch")?c="ðŸŒ Koneksi bermasalah. Periksa internet Anda dan coba lagi.":a.message.includes("permission")||a.message.includes("unauthorized")?c="ðŸ”’ Tidak memiliki izin untuk melakukan transaksi. Silakan login ulang.":a.message.includes("foreign key")||a.message.includes("Referensi data")?c="ðŸ”— Referensi data tidak valid. Silakan refresh halaman.":a.message&&(c=a.message),$.error(c,{duration:6e3})}finally{w(!1)}},q=i.filter(o=>o.type==="MENU"),v=i.filter(o=>o.type==="BOOK"),j=i.reduce((o,a)=>{const c=(a.price-(a.hpp||0))*a.quantity;return o+c},0),C=q.reduce((o,a)=>o+a.quantity,0),p=v.reduce((o,a)=>o+a.quantity,0);return e.jsxs("div",{className:"cart-summary",children:[e.jsxs("div",{className:"cart-info",children:[e.jsxs("p",{children:["Total (",i.length," item",i.length>1?"s":"",")",q.length>0&&v.length>0&&e.jsxs("span",{style:{fontSize:"12px",color:"#666",display:"block"},children:["â˜• ",C," menu â€¢ ðŸ“š ",p," buku"]}),j>0&&e.jsxs("span",{style:{fontSize:"11px",color:"#198754",display:"block"},children:["ðŸ’° Est. profit: Rp ",j.toLocaleString("id-ID")]})]}),e.jsxs("p",{style:{fontSize:"18px",fontWeight:"bold"},children:["Rp ",D.toLocaleString("id-ID")]})]}),e.jsx("button",{onClick:O,className:"btn-process",disabled:m||i.length===0,style:{opacity:m||i.length===0?.6:1,cursor:m||i.length===0?"not-allowed":"pointer",transition:"all 0.2s ease"},children:m?e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{marginRight:"8px"},children:"â³"}),"Memproses..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{marginRight:"8px"},children:"ðŸ’³"}),"Proses Pesanan"]})})]})}function I({product:i,onAddToCart:g,onRemoveFromCart:m,quantity:w}){return e.jsxs("div",{className:"product-card",children:[e.jsx("div",{className:"product-image-placeholder"}),e.jsxs("div",{className:"product-details",children:[e.jsx("h3",{children:i.name}),e.jsxs("p",{children:["Rp ",i.price.toLocaleString("id-ID")]})]}),e.jsxs("div",{className:"quantity-control",children:[e.jsx("button",{onClick:()=>m(i),children:e.jsx("img",{src:"/icons/icon-minus-circle.svg",alt:"Kurangi"})}),e.jsx("span",{children:w}),e.jsx("button",{onClick:()=>g(i),children:e.jsx("img",{src:"/icons/icon-plus-circle.svg",alt:"Tambah"})})]})]})}function G(){const[i,g]=l.useState([]),[m,w]=l.useState([]),[D,O]=l.useState(!0),[q,v]=l.useState(null),[j,C]=l.useState([]),[p,o]=l.useState(""),[a,c]=l.useState("menu"),E=l.useCallback(async()=>{try{const{data:t,error:n}=await h.from("menu_items").select("*");if(n)throw n;const d=[],r=t.map(async k=>{const{data:M,error:u}=await h.rpc("calculate_menu_prices",{p_menu_item_id:k.id});if(u)throw u;return{item:k,prices:M}});(await Promise.all(r)).forEach(({item:k,prices:M})=>{M.forEach(u=>{d.push({display_id:`${k.id}-${u.ingredient_id}`,menu_name:k.name,ingredient_name:u.ingredient_name,item_to_cart:{id:`menu-${k.id}-${u.ingredient_id}`,name:`${k.name} (${u.ingredient_name})`,price:u.sell_price,hpp:u.hpp,type:"MENU"}})})}),g(d)}catch(t){throw new Error("Menu: "+t.message)}},[]),y=l.useCallback(async()=>{try{const{data:t,error:n}=await h.from("books").select("*").gt("stock_quantity",0).order("title");if(n)throw n;const d=t.map(r=>({display_id:`book-${r.id}`,item_to_cart:{id:`book-${r.id}`,name:`${r.title}${r.author?` - ${r.author}`:""}`,price:r.selling_price,hpp:r.purchase_price,type:"BOOK",book_id:r.id,stock:r.stock_quantity}}));w(d)}catch(t){throw new Error("Books: "+t.message)}},[]),b=l.useCallback(async()=>{O(!0),v(null);try{await Promise.all([E(),y()])}catch(t){v("Gagal memuat data: "+t.message)}finally{O(!1)}},[E,y]);l.useEffect(()=>{b()},[b]);const B=l.useCallback(t=>{C(n=>{const d=n.find(r=>r.id===t.id);return d?t.type==="BOOK"&&d.quantity+1>t.stock?(alert(`Stok buku hanya tersedia ${t.stock} buah`),n):n.map(r=>r.id===t.id?{...r,quantity:r.quantity+1}:r):[...n,{...t,quantity:1}]})},[]),_=l.useCallback(t=>{C(n=>{const d=n.find(r=>r.id===t.id);return(d==null?void 0:d.quantity)>1?n.map(r=>r.id===t.id?{...r,quantity:r.quantity-1}:r):n.filter(r=>r.id!==t.id)})},[]),S=l.useCallback(()=>{C([]),b()},[b]),f=a==="menu"?i:m,x=l.useMemo(()=>p.trim()?f.filter(t=>t.item_to_cart.name.toLowerCase().includes(p.toLowerCase())):f,[f,p]),s=l.useMemo(()=>j.reduce((t,n)=>(t[n.id]=n.quantity,t),{}),[j]);return q?e.jsxs("div",{style:{padding:"40px 20px",textAlign:"center",color:"#dc3545"},children:[e.jsx("h3",{children:"Terjadi Kesalahan"}),e.jsx("p",{children:q}),e.jsx("button",{onClick:b,style:{padding:"10px 20px",backgroundColor:"#000",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Coba Lagi"})]}):D?e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh",flexDirection:"column",gap:"15px"},children:[e.jsx("div",{style:{width:"40px",height:"40px",border:"3px solid #f3f3f3",borderTop:"3px solid #000",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx("span",{children:"Memuat data..."}),e.jsx("style",{children:`
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `})]}):e.jsxs("div",{className:"kasir-page",children:[e.jsx("div",{className:"search-bar",children:e.jsx("input",{type:"text",placeholder:`Cari ${a==="menu"?"menu":"buku"}...`,value:p,onChange:t=>o(t.target.value)})}),e.jsxs("div",{className:"categories",children:[e.jsxs("button",{className:`category ${a==="menu"?"active":""}`,onClick:()=>{c("menu"),o("")},children:["â˜• Menu Kopi (",i.length,")"]}),e.jsxs("button",{className:`category ${a==="books"?"active":""}`,onClick:()=>{c("books"),o("")},children:["ðŸ“š Buku (",m.length,")"]})]}),e.jsx("div",{className:"product-list-container",children:x.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"40px",color:"#666",backgroundColor:"#f8f9fa",borderRadius:"8px",margin:"20px 0"},children:[e.jsxs("h3",{children:["Tidak ada ",a==="menu"?"menu":"buku"]}),e.jsx("p",{children:p?`Tidak ditemukan dengan kata kunci "${p}"`:`Belum ada ${a==="menu"?"menu":"buku"} yang tersedia.`})]}):x.map(t=>{const n=s[t.item_to_cart.id]||0;return e.jsx(I,{product:t.item_to_cart,quantity:n,onAddToCart:()=>B(t.item_to_cart),onRemoveFromCart:()=>_(t.item_to_cart)},t.display_id)})}),e.jsx(R,{cart:j,onOrderSuccess:S})]})}export{G as default};
