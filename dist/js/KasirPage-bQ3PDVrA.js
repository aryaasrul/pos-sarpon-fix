import{j as e,s as h}from"../assets/index-61PA5fo8.js";import{r as c}from"./chunk-Dqgx_XrJ.js";import{V as C}from"./chunk-nGiK0_2R.js";import"./chunk-CqGYk7DY.js";import"./chunk-DsIAwHzQ.js";function U({cart:i,onOrderSuccess:x}){const[p,b]=c.useState(!1),g=i.reduce((o,n)=>o+n.price*n.quantity,0),f=async()=>{if(i.length===0){C.error("Keranjang masih kosong!");return}b(!0);const o=C.loading("Memproses transaksi...");try{let n=null;try{const{data:{user:t}}=await h.auth.getUser();n=t==null?void 0:t.id}catch{}const l=i.filter(t=>t.type==="BOOK");if(l.length>0)for(const t of l){const d=parseInt(t.id.replace("book-",""));if(!d||isNaN(d))throw new Error(`Book ID tidak valid untuk item: ${t.name}`);const{data:u,error:_}=await h.from("books").select("stock_quantity, title, id").eq("id",d).single();if(_)throw new Error(`Gagal validasi buku: ${_.message}`);if(!u)throw new Error(`Buku dengan ID ${d} tidak ditemukan`);if(u.stock_quantity<t.quantity)throw new Error(`Stok buku "${u.title}" tidak mencukupi. Tersisa: ${u.stock_quantity}, diminta: ${t.quantity}`)}const O=i.reduce((t,d)=>{const u=(d.price-(d.hpp||0))*d.quantity;return t+u},0),{data:q,error:w}=await h.from("transactions").insert([{transaction_code:`TRX-${Date.now()}`,total_amount:g,total_profit:O,payment_method:"cash",notes:`${i.length} items - Auto generated transaction`}]).select().single();if(w)throw new Error(`Gagal membuat transaksi: ${w.message}`);const $=q.id,R=i.map(t=>{let d,u,_,P=null;if(t.type==="BOOK")d="book",u=parseInt(t.id.replace("book-","")),_=t.name;else{d="menu";const T=t.id.split("-");if(T.length>=2){if(u=parseInt(T[1]),t.name.includes("(")&&t.name.includes(")")){const a=t.name.match(/\(([^)]+)\)/);P=a?a[1]:null}}else u=parseInt(t.id.replace("menu-",""));_=t.name}return{transaction_id:$,item_type:d,item_id:u,item_name:_,ingredient_name:P,quantity:t.quantity,unit_price:t.price,total_price:t.price*t.quantity,hpp:t.hpp||0,profit_per_item:(t.price-(t.hpp||0))*t.quantity}}),{data:D,error:M}=await h.from("transaction_items").insert(R).select();if(M)throw await h.from("transactions").delete().eq("id",$),new Error(`Gagal menyimpan detail transaksi: ${M.message}`);if(l.length>0)for(const t of l){const d=parseInt(t.id.replace("book-",""));try{const{error:u}=await h.from("books").update({stock_quantity:h.raw(`stock_quantity - ${t.quantity}`),updated_at:new Date().toISOString()}).eq("id",d)}catch{}}C.dismiss(o);const j=i.filter(t=>t.type==="MENU").length,y=i.filter(t=>t.type==="BOOK").length;let N=`🎉 Transaksi berhasil!
💰 Total: Rp ${g.toLocaleString("id-ID")}`;j>0&&y>0?N+=`
☕ ${j} menu, 📚 ${y} buku`:j>0?N+=`
☕ ${j} item menu`:y>0&&(N+=`
📚 ${y} buku`),N+=`
🆔 ID: ${q.transaction_code}`,C.success(N,{duration:5e3}),x()}catch(n){C.dismiss(o);let l="Gagal memproses pesanan";n.message.includes("Stok buku")?l=`📚 ${n.message}`:n.message.includes("Book ID")?l="📚 Data buku tidak valid. Silakan refresh halaman dan coba lagi.":n.message.includes("network")||n.message.includes("fetch")?l="🌐 Koneksi bermasalah. Periksa internet Anda dan coba lagi.":n.message.includes("permission")||n.message.includes("unauthorized")?l="🔒 Tidak memiliki izin untuk melakukan transaksi. Silakan refresh halaman.":n.message.includes("foreign key")?l="🔗 Referensi data tidak valid. Silakan refresh halaman.":n.message&&(l=n.message),C.error(l,{duration:6e3})}finally{b(!1)}},E=i.filter(o=>o.type==="MENU"),I=i.filter(o=>o.type==="BOOK"),S=i.reduce((o,n)=>{const l=(n.price-(n.hpp||0))*n.quantity;return o+l},0),B=E.reduce((o,n)=>o+n.quantity,0),k=I.reduce((o,n)=>o+n.quantity,0);return e.jsxs("div",{className:"cart-summary",children:[e.jsxs("div",{className:"cart-info",children:[e.jsxs("p",{children:["Total (",i.length," item",i.length>1?"s":"",")",E.length>0&&I.length>0&&e.jsxs("span",{style:{fontSize:"12px",color:"#666",display:"block"},children:["☕ ",B," menu • 📚 ",k," buku"]}),S>0&&e.jsxs("span",{style:{fontSize:"11px",color:"#198754",display:"block"},children:["💰 Est. profit: Rp ",S.toLocaleString("id-ID")]})]}),e.jsxs("p",{style:{fontSize:"18px",fontWeight:"bold"},children:["Rp ",g.toLocaleString("id-ID")]})]}),e.jsx("button",{onClick:f,className:"btn-process",disabled:p||i.length===0,style:{opacity:p||i.length===0?.6:1,cursor:p||i.length===0?"not-allowed":"pointer",transition:"all 0.2s ease"},children:p?e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{marginRight:"8px"},children:"⏳"}),"Memproses..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{marginRight:"8px"},children:"💳"}),"Proses Pesanan"]})})]})}function z({product:i,quantity:x,onAddToCart:p,onRemoveFromCart:b,showBeansIndicator:g=!1}){return e.jsxs("div",{className:"product-card",children:[e.jsxs("div",{className:"product-info",children:[e.jsxs("h3",{className:"product-name",children:[i.name,g&&e.jsxs("span",{className:"beans-badge",children:[e.jsx("img",{src:"/icons/Filter.svg",alt:"Beans",className:"beans-icon"}),"Pilih Beans"]})]}),e.jsxs("div",{className:"product-price",children:[e.jsx("img",{src:"/icons/Tick-Square.svg",alt:"Price",className:"price-icon"}),"Rp ",i.price.toLocaleString("id-ID")]}),i.type==="BOOK"&&i.stock&&e.jsxs("div",{className:"product-stock",children:[e.jsx("img",{src:"/icons/database-icon.svg",alt:"Stock",className:"stock-icon"}),"Stok: ",i.stock]})]}),e.jsx("div",{className:"product-actions",children:x>0?e.jsxs("div",{className:"quantity-controls",children:[e.jsx("button",{className:"quantity-btn decrease",onClick:b,children:e.jsx("img",{src:"/icons/icon-minus-circle.svg",alt:"Remove"})}),e.jsx("span",{className:"quantity",children:x}),e.jsx("button",{className:"quantity-btn increase",onClick:p,children:e.jsx("img",{src:"/icons/icon-plus-circle.svg",alt:"Add"})})]}):e.jsxs("button",{className:"add-btn",onClick:p,children:[e.jsx("img",{src:g?"/icons/Filter.svg":"/icons/Plus-square.svg",alt:"Add",className:"add-icon"}),g?"Pilih":"Tambah"]})})]})}function G({isOpen:i,onClose:x,menuItem:p,availableBeans:b,onSelectBean:g}){return!i||!p?null:e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content beans-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:[e.jsx("img",{src:"/icons/Filter.svg",alt:"Beans",className:"modal-icon"}),"Pilih Beans untuk ",p.name]}),e.jsx("button",{className:"modal-close-btn",onClick:x,children:e.jsx("img",{src:"/icons/Close-Square.svg",alt:"Close"})})]}),e.jsx("div",{className:"beans-grid",children:b.map(f=>e.jsx("button",{className:"bean-option",onClick:()=>g(f),children:e.jsxs("div",{className:"bean-info",children:[e.jsxs("div",{className:"bean-header",children:[e.jsx("img",{src:"/icons/laporan-icon.svg",alt:"Bean",className:"bean-icon"}),e.jsx("h3",{children:f.ingredient_name})]}),e.jsxs("p",{className:"bean-hpp",children:[e.jsx("img",{src:"/icons/database-icon.svg",alt:"HPP",className:"small-icon"}),"HPP: Rp ",f.hpp.toLocaleString("id-ID")]}),e.jsxs("div",{className:"bean-price",children:[e.jsx("img",{src:"/icons/Tick-Square.svg",alt:"Price",className:"small-icon"}),"Rp ",f.sell_price.toLocaleString("id-ID")]})]})},f.ingredient_id))})]})})}function J(){const[i,x]=c.useState([]),[p,b]=c.useState([]),[g,f]=c.useState(!0),[E,I]=c.useState(null),[S,B]=c.useState([]),[k,o]=c.useState(""),[n,l]=c.useState("menu"),[O,q]=c.useState(!1),[w,$]=c.useState(null),[R,D]=c.useState([]),M=c.useCallback(async()=>{try{const{data:a,error:r}=await h.from("menu_items").select("*");if(r)throw r;const m=[];for(const s of a){const{data:K,error:A}=await h.from("recipe_ingredients").select("id").eq("menu_item_id",s.id).limit(1);if(A)throw A;if(K&&K.length>0){const{data:v,error:F}=await h.rpc("calculate_coffee_menu_prices",{p_menu_item_id:s.id});if(!F&&v&&v.length>0)m.push({display_id:`${s.id}-coffee`,menu_name:s.name,category:s.category,has_variants:!0,beans_options:v,item_to_cart:{id:`menu-${s.id}`,name:s.name,price:v[0].sell_price,hpp:v[0].hpp,type:"MENU",menu_item_id:s.id,requires_bean_selection:!0,category:s.category}});else{const L=Math.ceil(s.fixed_cost*(1+s.profit_margin)/s.rounding_up)*s.rounding_up;m.push({display_id:`${s.id}-coffee-fallback`,menu_name:s.name,category:s.category,has_variants:!1,item_to_cart:{id:`menu-${s.id}-fallback`,name:s.name,price:L,hpp:s.fixed_cost,type:"MENU",category:s.category}})}}else{const{data:v,error:F}=await h.rpc("calculate_non_coffee_price",{p_menu_item_id:s.id}),L=v||Math.ceil(s.fixed_cost*(1+s.profit_margin)/s.rounding_up)*s.rounding_up;m.push({display_id:`${s.id}-non-coffee`,menu_name:s.name,category:s.category,has_variants:!1,item_to_cart:{id:`menu-${s.id}-non-coffee`,name:s.name,price:L,hpp:s.fixed_cost,type:"MENU",category:s.category}})}}x(m)}catch(a){throw new Error("Menu: "+a.message)}},[]),j=c.useCallback(async()=>{try{const{data:a,error:r}=await h.from("books").select("*").gt("stock_quantity",0).order("title");if(r)throw r;const m=a.map(s=>({display_id:`book-${s.id}`,item_to_cart:{id:`book-${s.id}`,name:`${s.title}${s.author?` - ${s.author}`:""}`,price:s.selling_price,hpp:s.purchase_price,type:"BOOK",book_id:s.id,stock:s.stock_quantity}}));b(m)}catch(a){throw new Error("Books: "+a.message)}},[]),y=c.useCallback(async()=>{f(!0),I(null);try{await Promise.all([M(),j()])}catch(a){I("Gagal memuat data: "+a.message)}finally{f(!1)}},[M,j]);c.useEffect(()=>{y()},[y]);const N=a=>{const r={id:`menu-${w.menu_item_id}-${a.ingredient_id}`,name:`${w.name} (${a.ingredient_name})`,price:a.sell_price,hpp:a.hpp,type:"MENU"};t(r),q(!1),$(null),D([])},t=c.useCallback(a=>{if(a.requires_bean_selection){const r=i.find(m=>m.item_to_cart.id===a.id);if(r&&r.beans_options){$(a),D(r.beans_options),q(!0);return}}B(r=>{const m=r.find(s=>s.id===a.id);return m?a.type==="BOOK"&&m.quantity+1>a.stock?(alert(`Stok buku hanya tersedia ${a.stock} buah`),r):r.map(s=>s.id===a.id?{...s,quantity:s.quantity+1}:s):[...r,{...a,quantity:1}]})},[i]),d=c.useCallback(a=>{B(r=>{const m=r.find(s=>s.id===a.id);return(m==null?void 0:m.quantity)>1?r.map(s=>s.id===a.id?{...s,quantity:s.quantity-1}:s):r.filter(s=>s.id!==a.id)})},[]),u=c.useCallback(()=>{B([]),y()},[y]),_=n==="menu"?i:p,P=c.useMemo(()=>k.trim()?_.filter(a=>a.item_to_cart.name.toLowerCase().includes(k.toLowerCase())):_,[_,k]),T=c.useMemo(()=>S.reduce((a,r)=>(a[r.id]=r.quantity,a),{}),[S]);return E?e.jsxs("div",{className:"error-state",children:[e.jsx("img",{src:"/icons/Close-Square.svg",alt:"Error",className:"error-icon"}),e.jsx("h3",{children:"Terjadi Kesalahan"}),e.jsx("p",{children:E}),e.jsxs("button",{onClick:y,className:"retry-btn",children:[e.jsx("img",{src:"/icons/Swap.svg",alt:"Retry"}),"Coba Lagi"]})]}):g?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner",children:e.jsx("img",{src:"/icons/Swap.svg",alt:"Loading",className:"spinning"})}),e.jsx("span",{children:"Memuat data..."})]}):e.jsxs("div",{className:"kasir-page",children:[e.jsx("div",{className:"search-bar",children:e.jsxs("div",{className:"search-input-container",children:[e.jsx("img",{src:"/icons/icons-search.svg",alt:"Search",className:"search-icon"}),e.jsx("input",{type:"text",placeholder:`Cari ${n==="menu"?"menu":"buku"}...`,value:k,onChange:a=>o(a.target.value)}),k&&e.jsx("button",{className:"clear-search-btn",onClick:()=>o(""),children:e.jsx("img",{src:"/icons/Close-Square.svg",alt:"Clear"})})]})}),e.jsxs("div",{className:"categories",children:[e.jsxs("button",{className:`category-btn ${n==="menu"?"active":""}`,onClick:()=>{l("menu"),o("")},children:[e.jsx("img",{src:"/icons/laporan-icon.svg",alt:"Menu",className:"tab-icon"}),"Menu (",i.length,")"]}),e.jsxs("button",{className:`category-btn ${n==="books"?"active":""}`,onClick:()=>{l("books"),o("")},children:[e.jsx("img",{src:"/icons/orders-icon.svg",alt:"Books",className:"tab-icon"}),"Buku (",p.length,")"]})]}),e.jsx("div",{className:"product-list-container",children:P.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("img",{src:n==="menu"?"/icons/laporan-icon.svg":"/icons/orders-icon.svg",alt:"Empty",className:"empty-icon"}),e.jsxs("h3",{children:["Tidak ada ",n==="menu"?"menu":"buku"]}),e.jsx("p",{children:k?`Tidak ditemukan dengan kata kunci "${k}"`:`Belum ada ${n==="menu"?"menu":"buku"} yang tersedia.`}),k&&e.jsxs("button",{className:"clear-filter-btn",onClick:()=>o(""),children:[e.jsx("img",{src:"/icons/Filter.svg",alt:"Clear"}),"Hapus Filter"]})]}):P.map(a=>{const r=T[a.item_to_cart.id]||0;return e.jsx(z,{product:a.item_to_cart,quantity:r,onAddToCart:()=>t(a.item_to_cart),onRemoveFromCart:()=>d(a.item_to_cart),showBeansIndicator:a.has_variants},a.display_id)})}),e.jsx(U,{cart:S,onOrderSuccess:u}),e.jsx(G,{isOpen:O,onClose:()=>{q(!1),$(null),D([])},menuItem:w,availableBeans:R,onSelectBean:N})]})}export{J as default};
