import{j as e,s as u}from"../assets/index-gqo0DhI4.js";import{r as c}from"./chunk-Dqgx_XrJ.js";import{V as S}from"./chunk-nGiK0_2R.js";import"./chunk-CqGYk7DY.js";import"./chunk-DsIAwHzQ.js";function R(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){const h=Math.random()*16|0;return(i==="x"?h:h&3|8).toString(16)})}function I({cart:i,onOrderSuccess:h}){const[m,b]=c.useState(!1),O=i.reduce((o,n)=>o+n.price*n.quantity,0),N=async()=>{if(i.length===0){S.error("Keranjang masih kosong!");return}b(!0);const o=S.loading("Memproses transaksi...");try{const{data:{user:n},error:l}=await u.auth.getUser();if(l)throw new Error("Sesi tidak valid: "+l.message);if(!n)throw new Error("Silakan login untuk melakukan transaksi.");const j=R(),x=i.filter(r=>r.type==="BOOK");if(x.length>0)for(const r of x){if(!r.book_id)throw new Error(`Book ID missing for item: ${r.name}`);const{data:t,error:s}=await u.from("books").select("stock_quantity, title, id").eq("id",r.book_id).single();if(s)throw new Error(`Gagal validasi buku: ${s.message}`);if(!t)throw new Error(`Buku dengan ID ${r.book_id} tidak ditemukan`);if(t.stock_quantity<r.quantity)throw new Error(`Stok buku "${t.title}" tidak mencukupi. Tersisa: ${t.stock_quantity}, diminta: ${r.quantity}`)}const y=i.map(r=>{const t={transaction_id:j,name:r.name,quantity:r.quantity,price:r.price,hpp:r.hpp||0,user_id:n.id,product_type:r.type,created_at:new Date().toISOString()};return r.type==="BOOK"&&r.book_id&&(t.book_id=r.book_id),t}),{data:B,error:_}=await u.from("orders").insert(y).select();if(_)throw _.message.includes("uuid")||_.code==="22P02"?new Error("Format data tidak valid. Silakan refresh halaman dan coba lagi."):_.message.includes("foreign key")?new Error("Referensi data tidak valid. Silakan refresh halaman."):new Error(`Gagal menyimpan transaksi: ${_.message}`);if(x.length>0)for(const r of x)try{const{data:t,error:s}=await u.rpc("decrement_book_stock",{book_id:r.book_id,quantity_to_subtract:r.quantity});if(s&&s.message.includes("function")){const{data:a,error:D}=await u.from("books").select("stock_quantity, title").eq("id",r.book_id).single();if(D)throw new Error(`Gagal mengambil data buku: ${D.message}`);const M=a.stock_quantity-r.quantity;if(M<0)throw new Error(`Stok buku "${a.title}" tidak mencukupi untuk transaksi ini`);const{data:T,error:g}=await u.from("books").update({stock_quantity:M,updated_at:new Date().toISOString()}).eq("id",r.book_id).select("stock_quantity, title");if(g)throw new Error(`Gagal update stok: ${g.message}`)}else if(s)throw new Error(`Gagal update stok buku: ${s.message}`);const{error:d}=await u.from("book_stock_movements").insert([{book_id:r.book_id,movement_type:"OUT",quantity:r.quantity,reference_type:"SALE",reference_id:j,notes:`Penjualan - ${r.name}`,user_id:n.id,created_at:new Date().toISOString()}])}catch{}S.dismiss(o);const E=i.filter(r=>r.type==="MENU").length,f=i.filter(r=>r.type==="BOOK").length;let p=`ðŸŽ‰ Transaksi berhasil!
ðŸ’° Total: Rp ${O.toLocaleString("id-ID")}`;E>0&&f>0?p+=`
â˜• ${E} menu, ðŸ“š ${f} buku`:E>0?p+=`
â˜• ${E} item menu`:f>0&&(p+=`
ðŸ“š ${f} buku`),p+=`
ðŸ†” ID: ${j.slice(0,8)}...`,S.success(p,{duration:5e3}),h()}catch(n){S.dismiss(o);let l="Gagal memproses pesanan";n.message.includes("Stok buku")?l=`ðŸ“š ${n.message}`:n.message.includes("Book ID missing")?l="ðŸ“š Data buku tidak valid. Silakan refresh halaman dan coba lagi.":n.message.includes("uuid")||n.message.includes("Format data")?l="ðŸ”§ "+n.message:n.message.includes("network")||n.message.includes("fetch")?l="ðŸŒ Koneksi bermasalah. Periksa internet Anda dan coba lagi.":n.message.includes("permission")||n.message.includes("unauthorized")?l="ðŸ”’ Tidak memiliki izin untuk melakukan transaksi. Silakan login ulang.":n.message.includes("foreign key")||n.message.includes("Referensi data")?l="ðŸ”— Referensi data tidak valid. Silakan refresh halaman.":n.message&&(l=n.message),S.error(l,{duration:6e3})}finally{b(!1)}},q=i.filter(o=>o.type==="MENU"),v=i.filter(o=>o.type==="BOOK"),w=i.reduce((o,n)=>{const l=(n.price-(n.hpp||0))*n.quantity;return o+l},0),C=q.reduce((o,n)=>o+n.quantity,0),k=v.reduce((o,n)=>o+n.quantity,0);return e.jsxs("div",{className:"cart-summary",children:[e.jsxs("div",{className:"cart-info",children:[e.jsxs("p",{children:["Total (",i.length," item",i.length>1?"s":"",")",q.length>0&&v.length>0&&e.jsxs("span",{style:{fontSize:"12px",color:"#666",display:"block"},children:["â˜• ",C," menu â€¢ ðŸ“š ",k," buku"]}),w>0&&e.jsxs("span",{style:{fontSize:"11px",color:"#198754",display:"block"},children:["ðŸ’° Est. profit: Rp ",w.toLocaleString("id-ID")]})]}),e.jsxs("p",{style:{fontSize:"18px",fontWeight:"bold"},children:["Rp ",O.toLocaleString("id-ID")]})]}),e.jsx("button",{onClick:N,className:"btn-process",disabled:m||i.length===0,style:{opacity:m||i.length===0?.6:1,cursor:m||i.length===0?"not-allowed":"pointer",transition:"all 0.2s ease"},children:m?e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{marginRight:"8px"},children:"â³"}),"Memproses..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{marginRight:"8px"},children:"ðŸ’³"}),"Proses Pesanan"]})})]})}function P({product:i,onAddToCart:h,onRemoveFromCart:m,quantity:b}){return e.jsxs("div",{className:"product-card",children:[e.jsx("div",{className:"product-image-placeholder"}),e.jsxs("div",{className:"product-details",children:[e.jsx("h3",{children:i.name}),e.jsxs("p",{children:["Rp ",i.price.toLocaleString("id-ID")]})]}),e.jsxs("div",{className:"quantity-control",children:[e.jsx("button",{onClick:()=>m(i),children:e.jsx("img",{src:"/icons/icon-minus-circle.svg",alt:"Kurangi"})}),e.jsx("span",{children:b}),e.jsx("button",{onClick:()=>h(i),children:e.jsx("img",{src:"/icons/icon-plus-circle.svg",alt:"Tambah"})})]})]})}function F(){const[i,h]=c.useState([]),[m,b]=c.useState([]),[O,N]=c.useState(!0),[q,v]=c.useState(null),[w,C]=c.useState([]),[k,o]=c.useState(""),[n,l]=c.useState("menu"),j=c.useCallback(async()=>{try{const{data:t,error:s}=await u.from("menu_items").select("*");if(s)throw s;const d=[];for(const a of t){const{data:D,error:M}=await u.from("recipe_ingredients").select("id").eq("menu_item_id",a.id).limit(1);if(M)throw M;if(D&&D.length>0){const{data:T,error:g}=await u.rpc("calculate_menu_prices",{p_menu_item_id:a.id});if(g)throw g;T.forEach($=>{d.push({display_id:`${a.id}-${$.ingredient_id}`,menu_name:a.name,ingredient_name:$.ingredient_name,item_to_cart:{id:`menu-${a.id}-${$.ingredient_id}`,name:`${a.name} (${$.ingredient_name})`,price:$.sell_price,hpp:$.hpp,type:"MENU"}})})}else{const{data:T,error:g}=await u.rpc("calculate_non_coffee_price",{p_menu_item_id:a.id});if(g)throw g;d.push({display_id:`${a.id}-non-coffee`,menu_name:a.name,ingredient_name:"Non-Coffee",item_to_cart:{id:`menu-${a.id}-non-coffee`,name:a.name,price:T,hpp:a.fixed_cost,type:"MENU"}})}}h(d)}catch(t){throw new Error("Menu: "+t.message)}},[]),x=c.useCallback(async()=>{try{const{data:t,error:s}=await u.from("books").select("*").gt("stock_quantity",0).order("title");if(s)throw s;const d=t.map(a=>({display_id:`book-${a.id}`,item_to_cart:{id:`book-${a.id}`,name:`${a.title}${a.author?` - ${a.author}`:""}`,price:a.selling_price,hpp:a.purchase_price,type:"BOOK",book_id:a.id,stock:a.stock_quantity}}));b(d)}catch(t){throw new Error("Books: "+t.message)}},[]),y=c.useCallback(async()=>{N(!0),v(null);try{await Promise.all([j(),x()])}catch(t){v("Gagal memuat data: "+t.message)}finally{N(!1)}},[j,x]);c.useEffect(()=>{y()},[y]);const B=c.useCallback(t=>{C(s=>{const d=s.find(a=>a.id===t.id);return d?t.type==="BOOK"&&d.quantity+1>t.stock?(alert(`Stok buku hanya tersedia ${t.stock} buah`),s):s.map(a=>a.id===t.id?{...a,quantity:a.quantity+1}:a):[...s,{...t,quantity:1}]})},[]),_=c.useCallback(t=>{C(s=>{const d=s.find(a=>a.id===t.id);return(d==null?void 0:d.quantity)>1?s.map(a=>a.id===t.id?{...a,quantity:a.quantity-1}:a):s.filter(a=>a.id!==t.id)})},[]),E=c.useCallback(()=>{C([]),y()},[y]),f=n==="menu"?i:m,p=c.useMemo(()=>k.trim()?f.filter(t=>t.item_to_cart.name.toLowerCase().includes(k.toLowerCase())):f,[f,k]),r=c.useMemo(()=>w.reduce((t,s)=>(t[s.id]=s.quantity,t),{}),[w]);return q?e.jsxs("div",{style:{padding:"40px 20px",textAlign:"center",color:"#dc3545"},children:[e.jsx("h3",{children:"Terjadi Kesalahan"}),e.jsx("p",{children:q}),e.jsx("button",{onClick:y,style:{padding:"10px 20px",backgroundColor:"#000",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Coba Lagi"})]}):O?e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh",flexDirection:"column",gap:"15px"},children:[e.jsx("div",{style:{width:"40px",height:"40px",border:"3px solid #f3f3f3",borderTop:"3px solid #000",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx("span",{children:"Memuat data..."}),e.jsx("style",{children:`
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `})]}):e.jsxs("div",{className:"kasir-page",children:[e.jsx("div",{className:"search-bar",children:e.jsx("input",{type:"text",placeholder:`Cari ${n==="menu"?"menu":"buku"}...`,value:k,onChange:t=>o(t.target.value)})}),e.jsxs("div",{className:"categories",children:[e.jsxs("button",{className:`category ${n==="menu"?"active":""}`,onClick:()=>{l("menu"),o("")},children:["â˜• Menu (",i.length,")"]}),e.jsxs("button",{className:`category ${n==="books"?"active":""}`,onClick:()=>{l("books"),o("")},children:["ðŸ“š Buku (",m.length,")"]})]}),e.jsx("div",{className:"product-list-container",children:p.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"40px",color:"#666",backgroundColor:"#f8f9fa",borderRadius:"8px",margin:"20px 0"},children:[e.jsxs("h3",{children:["Tidak ada ",n==="menu"?"menu":"buku"]}),e.jsx("p",{children:k?`Tidak ditemukan dengan kata kunci "${k}"`:`Belum ada ${n==="menu"?"menu":"buku"} yang tersedia.`})]}):p.map(t=>{const s=r[t.item_to_cart.id]||0;return e.jsx(P,{product:t.item_to_cart,quantity:s,onAddToCart:()=>B(t.item_to_cart),onRemoveFromCart:()=>_(t.item_to_cart)},t.display_id)})}),e.jsx(I,{cart:w,onOrderSuccess:E})]})}export{F as default};
