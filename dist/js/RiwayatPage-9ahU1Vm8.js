import{j as e,s as y}from"../assets/index-61PA5fo8.js";import{r as m}from"./chunk-Dqgx_XrJ.js";import{V as b}from"./chunk-nGiK0_2R.js";import"./chunk-CqGYk7DY.js";import"./chunk-DsIAwHzQ.js";function k({isOpen:u,onClose:o,onSave:i}){const[h,p]=m.useState(""),[j,f]=m.useState(""),v=c=>{if(c.preventDefault(),!h||!j){alert("Nama dan jumlah pengeluaran harus diisi.");return}const g={name:h,amount:parseInt(j,10)};i(g)};return u?e.jsx("div",{className:"modal-overlay",children:e.jsx("div",{className:"modal-content",children:e.jsxs("form",{onSubmit:v,children:[e.jsx("h2",{children:"Tambah Pengeluaran Baru"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"expense-name",children:"Nama Pengeluaran"}),e.jsx("input",{id:"expense-name",type:"text",value:h,onChange:c=>p(c.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"expense-amount",children:"Jumlah (Rp)"}),e.jsx("input",{id:"expense-amount",type:"number",value:j,onChange:c=>f(c.target.value),required:!0})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"btn-cancel",onClick:o,children:"Batal"}),e.jsx("button",{type:"submit",className:"btn-save",children:"Simpan"})]})]})})}):null}function S({date:u,items:o,type:i,balance:h}){const[p,j]=m.useState(!0),f=o.reduce((t,n)=>t+(i==="income"?n.total_amount:n.amount),0),v=i==="income"?o.reduce((t,n)=>t+(n.profit||0),0):0,c=()=>i==="income"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Transaksi"}),e.jsxs("span",{className:"amount income",children:["+ Rp ",f.toLocaleString("id-ID")]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Laba"}),e.jsxs("span",{className:"amount income",children:["+ Rp ",v.toLocaleString("id-ID")]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Pengeluaran"}),e.jsxs("span",{className:"amount expense",children:["- Rp ",f.toLocaleString("id-ID")]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Sisa Saldo"}),e.jsxs("span",{children:["Rp ",h.toLocaleString("id-ID")]})]})]}),g=()=>{if(i==="income"){const t=o.reduce((n,l)=>(n[l.name]||(n[l.name]={...l,quantity:0,total:0}),n[l.name].quantity+=l.quantity,n[l.name].total+=l.total_amount,n),{});return Object.values(t).map(n=>e.jsxs("div",{className:"transaction-item",children:[e.jsxs("span",{children:[n.quantity,"x ",n.name]}),e.jsxs("span",{className:"amount income",children:["+ Rp ",n.total.toLocaleString("id-ID")]})]},`${n.id}-${n.name}`))}return o.map(t=>e.jsxs("div",{className:"transaction-item",children:[e.jsx("span",{children:t.name}),e.jsxs("span",{className:"amount expense",children:["- Rp ",t.amount.toLocaleString("id-ID")]})]},t.id))};return e.jsxs("div",{className:"date-group-accordion",children:[e.jsxs("button",{className:"accordion-header",onClick:()=>j(!p),children:[e.jsx("h3",{children:u}),e.jsx("img",{src:p?"/icons/Arrow-Up-2.svg":"/icons/Arrow-Down-2.svg",alt:"toggle"})]}),p&&e.jsxs("div",{className:"accordion-body",children:[e.jsx("div",{className:"summary-section",children:c()}),e.jsx("div",{className:"item-details-section",children:g()})]})]})}function O(){const[u,o]=m.useState("pemasukan"),[i,h]=m.useState([]),[p,j]=m.useState([]),[f,v]=m.useState(!0),[c,g]=m.useState(!1),t=i.reduce((s,a)=>s+a.total_amount,0),n=p.reduce((s,a)=>s+a.amount,0),l=t-n,_=async()=>{v(!0);try{const[s,a]=await Promise.all([y.from("transactions").select(`
            *,
            transaction_items (
              item_type,
              item_name,
              ingredient_name,
              quantity,
              unit_price,
              total_price,
              profit_per_item
            )
          `).order("created_at",{ascending:!1}),y.from("expenses").select("*").order("created_at",{ascending:!1})]);if(s.error)throw s.error;if(a.error)throw a.error;const x=[];s.data.forEach(r=>{r.transaction_items.forEach(d=>{x.push({id:`${r.id}-${d.item_name}`,transaction_id:r.id,transaction_code:r.transaction_code,name:d.ingredient_name?`${d.item_name} (${d.ingredient_name})`:d.item_name,quantity:d.quantity,price:d.unit_price,total_amount:d.total_price,profit:d.profit_per_item,created_at:r.created_at,payment_method:r.payment_method})})}),h(x),j(a.data)}catch{b.error("Gagal mengambil data riwayat.")}finally{v(!1)}};m.useEffect(()=>{_()},[]);const w=async s=>{try{const a={...s,group_id:"exp_"+Date.now()},{error:x}=await y.from("expenses").insert([a]);if(x)throw x;b.success("Pengeluaran berhasil disimpan."),g(!1),_()}catch(a){b.error("Gagal menyimpan pengeluaran: "+a.message)}},N=s=>s.reduce((a,x)=>{const r=new Date(x.created_at).toLocaleDateString("id-ID",{weekday:"long",year:"numeric",month:"long",day:"numeric"});return a[r]||(a[r]=[]),a[r].push(x),a},{}),D=N(i),I=N(p);return f?e.jsx("div",{children:"Memuat data riwayat..."}):e.jsxs("div",{className:"riwayat-page",children:[e.jsx("div",{className:"riwayat-header",children:e.jsxs("div",{className:"tab-container",children:[e.jsx("button",{className:`tab-btn ${u==="pemasukan"?"active":""}`,onClick:()=>o("pemasukan"),children:"Pemasukan"}),e.jsx("button",{className:`tab-btn ${u==="pengeluaran"?"active":""}`,onClick:()=>o("pengeluaran"),children:"Pengeluaran"})]})}),e.jsx("div",{className:"tab-content",children:u==="pemasukan"?Object.entries(D).map(([s,a])=>e.jsx(S,{date:s,items:a,type:"income"},s)):Object.entries(I).map(([s,a])=>e.jsx(S,{date:s,items:a,type:"expense",balance:l},s))}),u==="pengeluaran"&&e.jsx("button",{className:"btn-add-expense-fab",onClick:()=>g(!0),children:e.jsx("img",{src:"/icons/Plus-square.svg",alt:"Tambah Pengeluaran"})}),e.jsx(k,{isOpen:c,onClose:()=>g(!1),onSave:w})]})}export{O as default};
